<!DOCTYPE html>
<html>
<head>
    <title>Supabase Storage Analysis</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Supabase Storage Analysis</h1>
    <div id="results"></div>
    
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
        
        const supabaseUrl = 'https://gulydhhzwlltkxbfnclu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1bHlkaGh6d2xsdGt4YmZuY2x1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNzQ1ODIsImV4cCI6MjA3MjY1MDU4Mn0.hyegbm0PfIo5D0KdZRYoTHYVJw6k1WTITgoq-g_wFGM';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        const results = document.getElementById('results');
        
        function addResult(title, content, className = 'info') {
            const div = document.createElement('div');
            div.className = 'test-section';
            div.innerHTML = `<h3>${title}</h3><div class="${className}">${content}</div>`;
            results.appendChild(div);
        }
        
        async function analyzeStorage() {
            try {
                addResult('ğŸ” Starting Supabase Storage Analysis...', 'Checking storage configuration and capabilities');
                
                // 1. Check authentication status
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    addResult('ğŸ” Authentication', `âœ… Signed in as: ${session.user.email}<br>User ID: ${session.user.id}`, 'success');
                } else {
                    addResult('ğŸ” Authentication', 'âš ï¸ Not signed in - storage tests will be limited', 'warning');
                }
                
                // 2. List available buckets
                const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
                if (bucketsError) {
                    addResult('ğŸ“¦ Storage Buckets', `âŒ Error: ${bucketsError.message}`, 'error');
                } else {
                    const bucketList = buckets.map(b => `â€¢ ${b.name} (${b.public ? 'public' : 'private'})`).join('<br>');
                    addResult('ğŸ“¦ Storage Buckets', `âœ… Found ${buckets.length} buckets:<br>${bucketList}`, 'success');
                    
                    // Check for voice-recordings bucket specifically
                    const voiceBucket = buckets.find(b => b.name === 'voice-recordings');
                    if (voiceBucket) {
                        addResult('ğŸ¤ Voice Recordings Bucket', `âœ… Found voice-recordings bucket<br>â€¢ Public: ${voiceBucket.public}<br>â€¢ ID: ${voiceBucket.id}`, 'success');
                        
                        // Test file operations if signed in
                        if (session) {
                            await testVoiceRecordingsBucket(session.user.id);
                        } else {
                            addResult('ğŸ§ª Bucket Tests', 'âš ï¸ Skipped - requires authentication', 'warning');
                        }
                    } else {
                        addResult('ğŸ¤ Voice Recordings Bucket', 'âŒ voice-recordings bucket not found', 'error');
                    }
                }
                
                // 3. Test database access
                if (session) {
                    await testDatabaseAccess(session.user.id);
                }
                
                // 4. Calculate storage requirements and limits
                calculateStorageRequirements();
                
            } catch (error) {
                addResult('âŒ Analysis Failed', `Error: ${error.message}`, 'error');
            }
        }
        
        async function testVoiceRecordingsBucket(userId) {
            try {
                // Test upload
                const testBlob = new Blob(['test audio data'], { type: 'audio/webm' });
                const testPath = `${userId}/test-${Date.now()}.webm`;
                
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('voice-recordings')
                    .upload(testPath, testBlob, { upsert: true });
                    
                if (uploadError) {
                    addResult('ğŸ“¤ Upload Test', `âŒ Upload failed: ${uploadError.message}`, 'error');
                    return;
                } else {
                    addResult('ğŸ“¤ Upload Test', `âœ… Upload successful: ${uploadData.path}`, 'success');
                }
                
                // Test download
                const { data: downloadData, error: downloadError } = await supabase.storage
                    .from('voice-recordings')
                    .download(testPath);
                    
                if (downloadError) {
                    addResult('ğŸ“¥ Download Test', `âŒ Download failed: ${downloadError.message}`, 'error');
                } else {
                    addResult('ğŸ“¥ Download Test', `âœ… Download successful: ${downloadData.size} bytes`, 'success');
                }
                
                // Test list files
                const { data: files, error: listError } = await supabase.storage
                    .from('voice-recordings')
                    .list(userId, { limit: 10 });
                    
                if (listError) {
                    addResult('ğŸ“‹ List Files Test', `âŒ List failed: ${listError.message}`, 'error');
                } else {
                    addResult('ğŸ“‹ List Files Test', `âœ… Listed ${files.length} files in user folder`, 'success');
                }
                
                // Clean up test file
                await supabase.storage.from('voice-recordings').remove([testPath]);
                
            } catch (error) {
                addResult('ğŸ§ª Bucket Tests', `âŒ Test failed: ${error.message}`, 'error');
            }
        }
        
        async function testDatabaseAccess(userId) {
            try {
                // Test voice_recordings table access
                const { data, error } = await supabase
                    .from('voice_recordings')
                    .select('*')
                    .limit(5);
                    
                if (error) {
                    addResult('ğŸ—„ï¸ Database Access', `âŒ voice_recordings table error: ${error.message}`, 'error');
                } else {
                    addResult('ğŸ—„ï¸ Database Access', `âœ… voice_recordings table accessible (${data.length} records found)`, 'success');
                }
            } catch (error) {
                addResult('ğŸ—„ï¸ Database Access', `âŒ Database test failed: ${error.message}`, 'error');
            }
        }
        
        function calculateStorageRequirements() {
            const requirements = `
                <h4>ğŸ“Š Voice Recording Storage Requirements Analysis:</h4>
                
                <h5>ğŸ¯ Recording Specifications:</h5>
                â€¢ Format: WebM with Opus codec (most efficient)<br>
                â€¢ Bitrate: 64 kbps (good quality for speech)<br>
                â€¢ Sample Rate: 48kHz mono<br>
                â€¢ Estimated file size: ~0.5 MB per minute<br><br>
                
                <h5>ğŸ“ˆ Usage Estimates:</h5>
                â€¢ 5-minute conversation: ~2.5 MB<br>
                â€¢ 10-minute conversation: ~5 MB<br>
                â€¢ 30-minute conversation: ~15 MB<br>
                â€¢ 100 conversations/month: ~250-1500 MB (depending on length)<br><br>
                
                <h5>ğŸ—ï¸ Supabase Free Tier Limits:</h5>
                â€¢ Storage: 1 GB total (shared across all files)<br>
                â€¢ Bandwidth: 2 GB/month<br>
                â€¢ File size limit: Configurable (we set 50MB)<br><br>
                
                <h5>ğŸ’° Supabase Pro Tier ($25/month):</h5>
                â€¢ Storage: 8 GB included, then $0.021/GB<br>
                â€¢ Bandwidth: 250 GB/month included<br>
                â€¢ Much higher limits<br><br>
                
                <h5>âš ï¸ Considerations:</h5>
                â€¢ Auto-deletion after 90 days (configurable)<br>
                â€¢ Compression reduces file sizes significantly<br>
                â€¢ Guest recordings for demos<br>
                â€¢ Test recordings (small impact)
            `;
            
            addResult('ğŸ“Š Storage Requirements', requirements, 'info');
            
            // Recommendations
            const recommendations = `
                <h4>âœ… Recommendations:</h4>
                
                <strong>For Development/Testing:</strong><br>
                â€¢ Supabase Free tier is sufficient<br>
                â€¢ 1GB can handle ~200-400 conversations<br>
                â€¢ Auto-cleanup helps manage space<br><br>
                
                <strong>For Production:</strong><br>
                â€¢ Consider Supabase Pro for higher limits<br>
                â€¢ Monitor storage usage in dashboard<br>
                â€¢ Implement user-configurable retention periods<br>
                â€¢ Consider compression optimizations<br><br>
                
                <strong>Alternative Solutions (if needed):</strong><br>
                â€¢ AWS S3 (cheaper for large volumes)<br>
                â€¢ Google Cloud Storage<br>
                â€¢ Azure Blob Storage<br>
                â€¢ But Supabase integration is much simpler!
            `;
            
            addResult('ğŸ’¡ Recommendations', recommendations, 'success');
        }
        
        // Start analysis
        analyzeStorage();
    </script>
</body>
</html>