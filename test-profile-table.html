<!DOCTYPE html>
<html>
<head>
    <title>Test user_profiles Table</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Testing user_profiles Table</h1>
    <button onclick="testTable()">Test Table Access</button>
    <pre id="output"></pre>

    <script>
        const SUPABASE_URL = "https://gulydhhzwlltkxbfnclu.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1bHlkaGh6d2xsdGt4YmZuY2x1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNzQ1ODIsImV4cCI6MjA3MjY1MDU4Mn0.hyegbm0PfIo5D0KdZRYoTHYVJw6k1WTITgoq-g_wFGM";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        async function testTable() {
            const output = document.getElementById('output');
            output.textContent = 'Testing...\n';
            
            try {
                // Test 1: Check if we can query the table
                output.textContent += '\n1. Testing SELECT on user_profiles...\n';
                const { data: selectData, error: selectError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .limit(1);
                
                if (selectError) {
                    output.textContent += `❌ SELECT Error: ${JSON.stringify(selectError, null, 2)}\n`;
                } else {
                    output.textContent += `✅ SELECT Success: ${JSON.stringify(selectData, null, 2)}\n`;
                }
                
                // Test 2: Check auth user
                output.textContent += '\n2. Getting current user...\n';
                const { data: userData, error: userError } = await supabase.auth.getUser();
                
                if (userError) {
                    output.textContent += `❌ Auth Error: ${JSON.stringify(userError, null, 2)}\n`;
                } else if (!userData.user) {
                    output.textContent += `⚠️ No user logged in\n`;
                } else {
                    output.textContent += `✅ User ID: ${userData.user.id}\n`;
                    
                    // Test 3: Try to insert/upsert
                    output.textContent += '\n3. Testing UPSERT on user_profiles...\n';
                    const testData = {
                        user_id: userData.user.id,
                        preferred_name: 'Test Name',
                        age: 30,
                        location: 'Test Location',
                        hometown: 'Test Hometown',
                        onboarding_completed: false,
                        first_conversation_completed: false,
                        profile_completeness_score: 25,
                    };
                    
                    output.textContent += `Data to upsert: ${JSON.stringify(testData, null, 2)}\n`;
                    
                    const { data: upsertData, error: upsertError } = await supabase
                        .from('user_profiles')
                        .upsert(testData, { onConflict: 'user_id' })
                        .select();
                    
                    if (upsertError) {
                        output.textContent += `❌ UPSERT Error: ${JSON.stringify(upsertError, null, 2)}\n`;
                    } else {
                        output.textContent += `✅ UPSERT Success: ${JSON.stringify(upsertData, null, 2)}\n`;
                    }
                }
                
            } catch (error) {
                output.textContent += `\n❌ Unexpected Error: ${error}\n${error.stack}\n`;
            }
        }
    </script>
</body>
</html>
